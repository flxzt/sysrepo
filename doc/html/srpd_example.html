<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>sysrepo: sysrepo-plugind Plugin Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="cesnet-style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">sysrepo<span id="projectnumber">&#160;2.2.117</span>
   </div>
   <div id="projectbrief">YANG-based system repository for all-around configuration management.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('srpd_example.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">sysrepo-plugind Plugin Example</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This page includes a guide on how to write a simple YANG module and then get Sysrepo to handle its data either as a <a class="el" href="bins.html">plugin</a> or a stand-alone daemon. It is best to have at least a <a class="el" href="index.html#about">basic understanding</a> of Sysrepo before continuing.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Simple YANG module</h1>
<p><a class="anchor" id="yang_module"></a> For any device you want to manage with Sysrepo you will need a <a class="el" href="index.html#rfcs">YANG</a> module of the device. The language is quite rich and allows for description of almost any system. As an example, an <b>oven</b> will be fully managed by Sysrepo. All basic parts of YANG will be covered, namely configuration data, state data, RPCs, and notifications.</p>
<p>To simplify things, our oven is a cheap model that has only a switch for turning it on and off and a slider to set the temperature. However, it can provide information about the actual temperature inside and also notify the cook when the internal temperature reaches the configured temperature. Furthermore, raw food can be prepared in advance and the oven can automatically put it inside or remove it if prompted. That leaves us with this YANG model:</p>
<div class="fragment"><div class="line">module oven {</div>
<div class="line">    namespace &quot;urn:sysrepo:oven&quot;;</div>
<div class="line">    prefix ov;</div>
<div class="line"> </div>
<div class="line">    revision 2018-01-19 {</div>
<div class="line">        description &quot;Initial revision.&quot;;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    typedef oven-temperature {</div>
<div class="line">        description &quot;Temperature range that is accepted by the oven.&quot;;</div>
<div class="line">        type uint8 {</div>
<div class="line">            range &quot;0..250&quot;;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    container oven {</div>
<div class="line">        description &quot;Configuration container of the oven.&quot;;</div>
<div class="line"> </div>
<div class="line">        leaf turned-on {</div>
<div class="line">            description &quot;Main switch determining whether the oven is on or off.&quot;;</div>
<div class="line">            type boolean;</div>
<div class="line">            default false;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        leaf temperature {</div>
<div class="line">            description &quot;Slider for configuring the desired temperature.&quot;;</div>
<div class="line">            type oven-temperature;</div>
<div class="line">            default 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    container oven-state {</div>
<div class="line">        description &quot;State data container of the oven.&quot;;</div>
<div class="line">        config false;</div>
<div class="line"> </div>
<div class="line">        leaf temperature {</div>
<div class="line">            description &quot;Actual temperature inside the oven.&quot;;</div>
<div class="line">            type oven-temperature;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        leaf food-inside {</div>
<div class="line">            description &quot;Informs whether the food is inside the oven or not.&quot;;</div>
<div class="line">            type boolean;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rpc insert-food {</div>
<div class="line">        description &quot;Operation to order the oven to put the prepared food inside.&quot;;</div>
<div class="line"> </div>
<div class="line">        input {</div>
<div class="line">            leaf time {</div>
<div class="line">                description &quot;Parameter determining when to perform the operation.&quot;;</div>
<div class="line">                type enumeration {</div>
<div class="line">                    enum now {</div>
<div class="line">                        description &quot;Put the food in the oven immediately.&quot;;</div>
<div class="line">                    }</div>
<div class="line">                    enum on-oven-ready {</div>
<div class="line">                        description</div>
<div class="line">                            &quot;Put the food in once the temperature inside</div>
<div class="line">                             the oven is at least the configured one. If it</div>
<div class="line">                             is already, the behaviour is similar to &#39;now&#39;.&quot;;</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    rpc remove-food {</div>
<div class="line">        description &quot;Operation to order the oven to take the food out.&quot;;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    notification oven-ready {</div>
<div class="line">        description</div>
<div class="line">            &quot;Event of the configured temperature matching the actual</div>
<div class="line">             temperature inside the oven. If the configured temperature</div>
<div class="line">             is lower than the actual one, no notification is generated</div>
<div class="line">             when the oven cools down to the configured temperature.&quot;;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md15"></a>
Oven Plugin</h1>
<p><a class="anchor" id="oven_plugin"></a> Here it will be step-by-step explained how to write a proper <a class="el" href="bins.html">plugin</a> that will manage the oven. All code snippets are taken from the actual implementation.</p>
<p><a class="el" href="group__srpd__plugin__api.html">sysrepo-plugind Plugin API</a></p>
<h2><a class="anchor" id="autotoc_md16"></a>
Initialization</h2>
<p>In the initialization function you must generally initialize the device and create subscriptions to any relevant YANG nodes. </p><div class="fragment"><div class="line">food_inside = 0;</div>
<div class="line">insert_food_on_ready = 0;</div>
<div class="line">oven_temperature = 25;</div>
</div><!-- fragment --><p> To start with, the oven must certainly be informed about any changes in its configuration parameters so it is easiest to subscribe to the whole module. The flag <a class="el" href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5bac5b782dfbbfe74c8ff2b1642a8bb0afe" title="The subscriber wants to be notified about the current configuration at the moment of subscribing....">SR_SUBSCR_ENABLED</a> is set so that independently of the state of the oven (device) at the moment <code>sysrepo-plugind</code> starts, the currently stored configuration is applied to the device and consistency is kept. The other flag, <a class="el" href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5ba0530a7715e162ee90e298ce504239444" title="The subscriber does not support verification of the changes and wants to be notified only after the c...">SR_SUBSCR_DONE_ONLY</a> is used so that the callback is not called to verify any pending changes. For our example, as long as the value is valid based on YANG restrictions, it is always correct.</p>
<p>It is also possible to subscribe to an arbitrary configuration data subtree instead but it is not needed for this example. </p><div class="fragment"><div class="line">rc = <a class="code hl_function" href="group__change__subs__api.html#ga9fc19731882299fe1864ccc20b9bd842">sr_module_change_subscribe</a>(session, <span class="stringliteral">&quot;oven&quot;</span>, oven_config_change_cb, NULL, 0,</div>
<div class="line">        <a class="code hl_enumvalue" href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5bac5b782dfbbfe74c8ff2b1642a8bb0afe">SR_SUBSCR_ENABLED</a> | <a class="code hl_enumvalue" href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5ba0530a7715e162ee90e298ce504239444">SR_SUBSCR_DONE_ONLY</a>, &amp;subscription);</div>
<div class="ttc" id="agroup__change__subs__api_html_ga9fc19731882299fe1864ccc20b9bd842"><div class="ttname"><a href="group__change__subs__api.html#ga9fc19731882299fe1864ccc20b9bd842">sr_module_change_subscribe</a></div><div class="ttdeci">int sr_module_change_subscribe(sr_session_ctx_t *session, const char *module_name, const char *xpath, sr_module_change_cb callback, void *private_data, uint32_t priority, sr_subscr_options_t opts, sr_subscription_ctx_t **subscription)</div><div class="ttdoc">Subscribe for changes made in the specified module.</div></div>
<div class="ttc" id="agroup__subs__api_html_ggaa629478596b1e246553eac91a74b2b5ba0530a7715e162ee90e298ce504239444"><div class="ttname"><a href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5ba0530a7715e162ee90e298ce504239444">SR_SUBSCR_DONE_ONLY</a></div><div class="ttdeci">@ SR_SUBSCR_DONE_ONLY</div><div class="ttdoc">The subscriber does not support verification of the changes and wants to be notified only after the c...</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00406">sysrepo_types.h:406</a></div></div>
<div class="ttc" id="agroup__subs__api_html_ggaa629478596b1e246553eac91a74b2b5bac5b782dfbbfe74c8ff2b1642a8bb0afe"><div class="ttname"><a href="group__subs__api.html#ggaa629478596b1e246553eac91a74b2b5bac5b782dfbbfe74c8ff2b1642a8bb0afe">SR_SUBSCR_ENABLED</a></div><div class="ttdeci">@ SR_SUBSCR_ENABLED</div><div class="ttdoc">The subscriber wants to be notified about the current configuration at the moment of subscribing....</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00415">sysrepo_types.h:415</a></div></div>
</div><!-- fragment --><p> Then, as there are also state data in the oven model, a subscription that marks this plugin to be a (exclusive) provider of them is performed. It is called whenever Sysrepo needs the state data subtree, usually when a client asks for them.</p>
<p>Lastly, the plugin will also handle any RPC calls, which also need subsciptions. </p><div class="fragment"><div class="line">rc = <a class="code hl_function" href="group__rpc__subs__api.html#ga25197ad94de216b625a0c0e096499a54">sr_rpc_subscribe</a>(session, <span class="stringliteral">&quot;/oven:insert-food&quot;</span>, oven_insert_food_cb, NULL, 0, &amp;subscription);</div>
<div class="line">rc = <a class="code hl_function" href="group__rpc__subs__api.html#ga25197ad94de216b625a0c0e096499a54">sr_rpc_subscribe</a>(session, <span class="stringliteral">&quot;/oven:remove-food&quot;</span>, oven_remove_food_cb, NULL, 0, &amp;subscription);</div>
<div class="ttc" id="agroup__rpc__subs__api_html_ga25197ad94de216b625a0c0e096499a54"><div class="ttname"><a href="group__rpc__subs__api.html#ga25197ad94de216b625a0c0e096499a54">sr_rpc_subscribe</a></div><div class="ttdeci">int sr_rpc_subscribe(sr_session_ctx_t *session, const char *xpath, sr_rpc_cb callback, void *private_data, uint32_t priority, sr_subscr_options_t opts, sr_subscription_ctx_t **subscription)</div><div class="ttdoc">Subscribe for the delivery of an RPC/action. Data are represented as sr_val_t structures.</div></div>
</div><!-- fragment --><p> Sysrepo provides macros for plugins to be able to print messages in a unified manner so it is advised to use them. </p><div class="fragment"><div class="line">SRP_LOG_DBGMSG(<span class="stringliteral">&quot;OVEN: Oven plugin initialized successfully.&quot;</span>);</div>
</div><!-- fragment --><p> The general format is <code>SRP_LOG_(level)(MSG)</code>. Instead of <code>(level)</code> the message severity is written, one of <code>DBG</code>, <code>VRB</code>, <code>WRN</code>, or <code>ERR</code>. In the example the suffix <code>MSG</code> was used because there were no additional variable arguments specified. If there are, this suffix is omitted. The arguments are the same as one would use for the <code>printf()</code> function.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Cleanup</h2>
<p>As for cleanup, the tasks performed vary greatly and depend on the device. However, it is always required to properly terminate the subscriptions made in the init function and that is the only work required in this example. </p><div class="fragment"><div class="line"><a class="code hl_function" href="group__subs__api.html#ga8fe49b0cf74d5744cae2aa47d13d480b">sr_unsubscribe</a>(subscription);</div>
<div class="ttc" id="agroup__subs__api_html_ga8fe49b0cf74d5744cae2aa47d13d480b"><div class="ttname"><a href="group__subs__api.html#ga8fe49b0cf74d5744cae2aa47d13d480b">sr_unsubscribe</a></div><div class="ttdeci">int sr_unsubscribe(sr_subscription_ctx_t *subscription)</div><div class="ttdoc">Unsubscribe all the subscriptions in a subscription structure and free it.</div></div>
</div><!-- fragment --><p> <code>subscription</code> was defined as a global variable to simplify the code but it is possible to use <code>private_data</code>, for instance, to store it possibly also with any additional data your application needs. All the other callbacks assigned before can use the same mechanism for passing additional data if needed.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Configuration Data</h2>
<p>In the example it is subscribed for the module changes with <code>oven_config_change_cb()</code>. The code seen here is a simplification of the actual code but is better for understanding what the callback should do. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">oven_config_change_cb(<a class="code hl_typedef" href="sysrepo__types_8h.html#a0de3599f66e9100f930f60a0ab00c60c">sr_session_ctx_t</a> *session, <span class="keyword">const</span> <span class="keywordtype">char</span> *module_name, sr_notif_event_t event, <span class="keywordtype">void</span> *private_ctx)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> rc;</div>
<div class="line">    <a class="code hl_struct" href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a> *val;</div>
<div class="line"> </div>
<div class="line">    rc = <a class="code hl_function" href="group__get__data__api.html#ga7a2519c56957ea82729509651daa67b7">sr_get_item</a>(session, <span class="stringliteral">&quot;/oven:oven/temperature&quot;</span>, &amp;val);</div>
<div class="line">    <span class="keywordflow">if</span> (rc != <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>) {</div>
<div class="line">        <span class="keywordflow">goto</span> sr_error;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//apply the temperature to the device</span></div>
<div class="line">    <a class="code hl_function" href="group__get__data__api.html#ga064c0e3a4f251945d8dc97690df6cdad">sr_free_val</a>(val);</div>
<div class="line"> </div>
<div class="line">    rc = <a class="code hl_function" href="group__get__data__api.html#ga7a2519c56957ea82729509651daa67b7">sr_get_item</a>(session, <span class="stringliteral">&quot;/oven:oven/turned-on&quot;</span>, &amp;val);</div>
<div class="line">    <span class="keywordflow">if</span> (rc != <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>) {</div>
<div class="line">        <span class="keywordflow">goto</span> sr_error;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">//apply the switch state to the device</span></div>
<div class="line">    <a class="code hl_function" href="group__get__data__api.html#ga064c0e3a4f251945d8dc97690df6cdad">sr_free_val</a>(val);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>;</div>
<div class="line"> </div>
<div class="line">sr_error:</div>
<div class="line">    SRP_LOG_ERR(<span class="stringliteral">&quot;OVEN: Oven config change callback failed: %s.&quot;</span>, <a class="code hl_function" href="group__log__api.html#ga826d6ebe92424c1d4383f489541ac0ef">sr_strerror</a>(rc));</div>
<div class="line">    <span class="keywordflow">return</span> rc;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__get__data__api_html_ga064c0e3a4f251945d8dc97690df6cdad"><div class="ttname"><a href="group__get__data__api.html#ga064c0e3a4f251945d8dc97690df6cdad">sr_free_val</a></div><div class="ttdeci">void sr_free_val(sr_val_t *value)</div><div class="ttdoc">Free sr_val_t structure and all memory allocated within it.</div></div>
<div class="ttc" id="agroup__get__data__api_html_ga7a2519c56957ea82729509651daa67b7"><div class="ttname"><a href="group__get__data__api.html#ga7a2519c56957ea82729509651daa67b7">sr_get_item</a></div><div class="ttdeci">int sr_get_item(sr_session_ctx_t *session, const char *path, uint32_t timeout_ms, sr_val_t **value)</div><div class="ttdoc">Retrieve a single data element selected by the provided path. Data are represented as sr_val_t struct...</div></div>
<div class="ttc" id="agroup__log__api_html_ga826d6ebe92424c1d4383f489541ac0ef"><div class="ttname"><a href="group__log__api.html#ga826d6ebe92424c1d4383f489541ac0ef">sr_strerror</a></div><div class="ttdeci">const char * sr_strerror(int err_code)</div><div class="ttdoc">Returns the error message corresponding to the error code.</div></div>
<div class="ttc" id="agroup__log__api_html_gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3"><div class="ttname"><a href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a></div><div class="ttdeci">@ SR_ERR_OK</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00041">sysrepo_types.h:41</a></div></div>
<div class="ttc" id="asysrepo__types_8h_html_a0de3599f66e9100f930f60a0ab00c60c"><div class="ttname"><a href="sysrepo__types_8h.html#a0de3599f66e9100f930f60a0ab00c60c">sr_session_ctx_t</a></div><div class="ttdeci">struct sr_session_ctx_s sr_session_ctx_t</div><div class="ttdoc">Sysrepo session on a connection.</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00099">sysrepo_types.h:99</a></div></div>
<div class="ttc" id="asysrepo__types_8h_html_structsr__val__t"><div class="ttname"><a href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a></div><div class="ttdoc">Structure that contains value of an data element stored in the sysrepo datastore.</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00268">sysrepo_types.h:268</a></div></div>
</div><!-- fragment --><p> Firstly, as can be observed, the <code>event</code> variable is ignored. In our example we perform the same actions no matter which event is being processed, it will not be any other than <a class="el" href="group__change__subs__api.html#ggad007e862874bda7141c58ca72d8c1067a52e97346d4bf27ab64ad9233627ccf39">SR_EV_DONE</a> because of the subscription flags.</p>
<p>Then, all the relevant data nodes are read and applied. This approach is the most simple one and cannot be always employed but is fine in this case because it is possible to re-apply changes without any effect. More elaborate machanism, which returns the changes, is using <a class="el" href="group__change__subs__api.html#ga613064e7a7431a30eff2b99b87af5348" title="Create an iterator for retrieving the changes (list of newly added / removed / modified nodes) in mod...">sr_get_changes_iter()</a> with the provided session and thus getting only the specific changed values.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
State Data</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">oven_state_cb(<a class="code hl_typedef" href="sysrepo__types_8h.html#a0de3599f66e9100f930f60a0ab00c60c">sr_session_ctx_t</a> *session, <span class="keyword">const</span> <span class="keywordtype">char</span> *module_name, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> lyd_node **parent, <span class="keywordtype">void</span> *private_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> str[32];</div>
<div class="line"> </div>
<div class="line">    sprintf(str, <span class="stringliteral">&quot;%u&quot;</span>, oven_temperature);</div>
<div class="line">    lyd_new_path(*parent, NULL, <span class="stringliteral">&quot;/oven:oven-state/temperature&quot;</span>, str, 0, 0);</div>
<div class="line">    lyd_new_path(*parent, NULL, <span class="stringliteral">&quot;/oven:oven-state/food-inside&quot;</span>, food_inside ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>, 0, 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>;</div>
<div class="line">}</div>
</div><!-- fragment --><p> The state data callback is self-explaining. As the subscription was only for one container with 2 leaves as children, the <code>path</code> can only have one value. The corresponding children are created.</p>
<h2><a class="anchor" id="autotoc_md20"></a>
RPC Subscriptions</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">oven_insert_food_cb(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <a class="code hl_struct" href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a> *input, <span class="keyword">const</span> <span class="keywordtype">size_t</span> input_cnt,</div>
<div class="line">        <a class="code hl_struct" href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a> **output, <span class="keywordtype">size_t</span> *output_cnt, <span class="keywordtype">void</span> *private_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (food_inside) {</div>
<div class="line">        SRP_LOG_ERRMSG(<span class="stringliteral">&quot;OVEN: Food already in the oven.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a54b8e052585f2e7800ac98f22621f37b">SR_ERR_OPERATION_FAILED</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(input[0].data.enum_val, <span class="stringliteral">&quot;on-oven-ready&quot;</span>) == 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (insert_food_on_ready) {</div>
<div class="line">            SRP_LOG_ERRMSG(<span class="stringliteral">&quot;OVEN: Food already waiting for the oven to be ready.&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a54b8e052585f2e7800ac98f22621f37b">SR_ERR_OPERATION_FAILED</a>;</div>
<div class="line">        }</div>
<div class="line">        insert_food_on_ready = 1;</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    insert_food_on_ready = 0;</div>
<div class="line">    food_inside = 1;</div>
<div class="line">    SRP_LOG_DBGMSG(<span class="stringliteral">&quot;OVEN: Food put into the oven.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">oven_remove_food_cb(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <a class="code hl_struct" href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a> *input, <span class="keyword">const</span> <span class="keywordtype">size_t</span> input_cnt,</div>
<div class="line">        <a class="code hl_struct" href="sysrepo__types_8h.html#structsr__val__t">sr_val_t</a> **output, <span class="keywordtype">size_t</span> *output_cnt, <span class="keywordtype">void</span> *private_ctx)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (!food_inside) {</div>
<div class="line">        SRP_LOG_ERRMSG(<span class="stringliteral">&quot;OVEN: Food not in the oven.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a54b8e052585f2e7800ac98f22621f37b">SR_ERR_OPERATION_FAILED</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    food_inside = 0;</div>
<div class="line">    SRP_LOG_DBGMSG(<span class="stringliteral">&quot;OVEN: Food taken out of the oven.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a9349114b18324f7d763650d2cd577df3">SR_ERR_OK</a>;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__log__api_html_gga3541b16be4e12bd061b7e24d4be29c30a54b8e052585f2e7800ac98f22621f37b"><div class="ttname"><a href="group__log__api.html#gga3541b16be4e12bd061b7e24d4be29c30a54b8e052585f2e7800ac98f22621f37b">SR_ERR_OPERATION_FAILED</a></div><div class="ttdeci">@ SR_ERR_OPERATION_FAILED</div><div class="ttdef"><b>Definition</b> <a href="sysrepo__types_8h_source.html#l00051">sysrepo_types.h:51</a></div></div>
</div><!-- fragment --><p> RPC callbacks should execute the corresponding RPC. <code>remove-food</code> does only that. But <code>insert-food</code> has some input parameters defined so they need to be handled. In the same way, if there were some output parameters, they would need to be created and returned but that is not our case.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Notifications</h2>
<p>The provider of a notification does not need to subscribe to anything but simply generate any notifications whenever they occur. </p><div class="fragment"><div class="line">rc = sr_event_notif_send(sess, <span class="stringliteral">&quot;/oven:oven-ready&quot;</span>, NULL, 0);</div>
</div><!-- fragment --><p> It is quite straightforward as can be seen from the example. Additionally, if there were any children nodes of the notification, they would need to be created and then passed to the function.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Trying It Out</h2>
<p>The model and full plugin source can be found in <code>sysrepo/examples/plugin</code>. Once Sysrepo is built, the <code>oven</code> shared library is stored in <code>examples</code> but it is not installed automatically. Before installing and actually running the plugin it is best to go carefully through the source code. It is just a small well-documented file so it should not take long and one should understand the implemented <code>oven</code> functionality. Also, most of the information covered in the sections above is just basic and detailed descriptions of all these mechanisms can be found in other subpages in the parent <a class="el" href="dev_guide.html">developer guide</a> page.</p>
<p>Before being concerned with this particular plugin, Sysrepo must be properly built and installed. Having done that, you must install first the model, then the plugin. For installing the model, you can use <a class="el" href="bins.html">sysrepoctl</a>. Then, you can use <a class="el" href="bins.html">sysrepo-plugind</a> to install the plugin <code>oven.so</code> or manually put it into <a class="el" href="bins.html#srpd_plugins_path">plugins path</a>.</p>
<p>After that you should be ready to start <code>sysrepo-plugind</code>, which should load the plugin. If you enable debug messages, you should see that the <code>oven</code> plugin was successfully initialized.</p>
<p>Now you are free to play with the <code>oven</code> configuration, RPCs, and notifications. It should work like it is described in the YANG model and how would one expect an oven to behave. Here is one example use-case:</p>
<ol type="1">
<li>As the very first step, subscribe to <code>oven</code> notifications using <code>notif_subscribe_example</code> <pre class="fragment">notif_subscribe_example oven
</pre></li>
</ol>
<ol type="1">
<li><p class="startli">Prepare food to be inserted into the oven once it reaches a temperature, which will be configured later. The oven is turned off by default. In NETCONF terms, you execute the <code>insert-food</code> RPC. You can do that using <a class="el" href="bins.html">sysrepocfg</a> </p><pre class="fragment">sysrepocfg --rpc=vim
</pre><p class="startli">and input </p><pre class="fragment">&lt;insert-food xmlns="urn:sysrepo:oven"&gt;
    &lt;time&gt;on-oven-ready&lt;/time&gt;
&lt;/insert-food&gt;
</pre><p class="startli">as the RPC content. You should see some informational <code>sysrepo-plugind</code> output.</p>
</li>
<li><p class="startli">Now you are going to turn the oven on and expect to be notified once it reaches the configured temperature. Also, the food should be inserted at that moment. So, you execute </p><pre class="fragment">sysrepocfg --edit=vim --datastore running
</pre><p class="startli">with the content </p><pre class="fragment">&lt;oven xmlns="urn:sysrepo:oven"&gt;
    &lt;turned-on&gt;true&lt;/turned-on&gt;
    &lt;temperature&gt;200&lt;/temperature&gt;
&lt;/oven&gt;
</pre></li>
</ol>
<ol type="1">
<li><p class="startli">After ~4 seconds you should receive the notification. You can also verify that everything went correctly with </p><pre class="fragment">sysrepocfg --export --xpath /oven:*
</pre><p class="startli">The food should be inside the oven.</p>
</li>
<li><p class="startli">Once you think the food is baked just right, remove it with another RPC by </p><pre class="fragment">sysrepocfg --rpc=vim
</pre><p class="startli">with </p><pre class="fragment">&lt;remove-food xmlns="urn:sysrepo:oven"/&gt;
</pre><p class="startli">Bon appetit!</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md23"></a>
Oven Daemon</h1>
<p>If you want your device to have a stand-alone daemon that will run as a separate process not using <a class="el" href="bins.html">sysrepo-plugind</a> then you do not need to develop a plugin. Having a separate daemon actually has only a few differences that have been mentioned in the previous sentence.</p>
<p>As for the code itself, no specific functions are required as the code will not be compiled into a shared library but an executable binary. However, if the plugin is to be transformed into an application nothing prevents reusing the whole code.</p>
<p>All that is needed is a <code>main()</code> function that will call <code>sr_plugin_init_cb()</code> at the beginning and <code>sr_plugin_cleanup_cb()</code> before terminating. In addition, these functions need a Sysrepo session. To create one we first need a connection. So, a connection is created with <a class="el" href="group__conn__sess__api.html#ga822c82f228f5772907fb70ffa9c9ffce" title="Connects to the sysrepo datastore.">sr_connect()</a> and if successful, a session created with <a class="el" href="group__conn__sess__api.html#ga96b8accdeec370c08cddfde95d0741d2" title="Start a new session.">sr_session_start()</a>. Now, it is possible to call the <b>init</b> function and on daemon termination to properly cleanup by both calling the <b>cleanup</b> function and freeing the session and connection. Additionally, before being able to compile such an application, the printing macros would have to be changed as there will no longer be a master daemon that would handle printing messages. After these changes, the <code>oven</code> daemon should be ready. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dev_guide.html">Developer Guide</a></li>
    <li class="footer">Generated on Tue Jan 28 2025 10:56:44 for sysrepo by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
